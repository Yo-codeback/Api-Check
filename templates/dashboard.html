<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>API ç›£æ§ä¸­å¿ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            overflow-x: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
        }

        /* å…¨è¢å¹•æ¨¡å¼ */
        body.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 16px;
            border-bottom: 2px solid #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 100;
        }

        .header h1 {
            color: #00d4ff;
            font-size: 1.4em;
            text-shadow: 0 0 20px #00d4ff;
            font-weight: 300;
        }

        .time-display {
            font-size: 1.1em;
            color: #00d4ff;
            text-shadow: 0 0 10px #00d4ff;
            font-family: 'Courier New', monospace;
        }

        .main-container {
            height: calc(100vh - 60px);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.2);
        }

        .status-card h3 {
            color: #00d4ff;
            margin-bottom: 12px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-success {
            background: #00ff88;
            box-shadow: 0 0 15px #00ff88;
        }

        .status-error {
            background: #ff4444;
            box-shadow: 0 0 15px #ff4444;
        }

        .status-warning {
            background: #ffaa00;
            box-shadow: 0 0 15px #ffaa00;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .metric-label {
            color: #cccccc;
            font-size: 0.9em;
        }

        .metric-value {
            color: #ffffff;
            font-size: 0.95em;
            font-weight: 500;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .api-status {
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .api-success {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            border: 2px solid #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .api-error {
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
            border: 2px solid #ff4444;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
            animation: errorPulse 1s infinite;
        }

        .api-waiting {
            background: rgba(255, 170, 0, 0.1);
            color: #ffaa00;
            border: 2px solid #ffaa00;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.3);
        }

        @keyframes errorPulse {
            0% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.3); }
            50% { box-shadow: 0 0 30px rgba(255, 68, 68, 0.6); }
            100% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.3); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.8em;
            color: #cccccc;
        }

        .success-stat {
            border-color: rgba(0, 255, 136, 0.3);
        }

        .success-stat .stat-value {
            color: #00ff88;
        }

        .error-stat {
            border-color: rgba(255, 68, 68, 0.3);
        }

        .error-stat .stat-value {
            color: #ff4444;
        }

        .info-stat {
            border-color: rgba(0, 212, 255, 0.3);
        }

        .info-stat .stat-value {
            color: #00d4ff;
        }

        /* è­¦å ±è¦†è“‹å±¤ */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: alertBlink 0.5s infinite;
        }

        @keyframes alertBlink {
            0% { background: rgba(255, 0, 0, 0.9); }
            50% { background: rgba(255, 0, 0, 0.7); }
            100% { background: rgba(255, 0, 0, 0.9); }
        }

        .alert-content {
            text-align: center;
            color: white;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .alert-content h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .alert-content p {
            font-size: 0.8em;
            margin-bottom: 20px;
        }

        .alert-button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin: 0 8px;
        }

        .alert-button:hover {
            background: #cc3333;
        }

        /* é€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
            z-index: 200;
        }

        .connection-status.disconnected {
            background: #ff4444;
            box-shadow: 0 0 10px #ff4444;
            animation: connectionPulse 1s infinite;
        }

        @keyframes connectionPulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.2em;
            }
            
            .time-display {
                font-size: 1em;
            }
            
            .main-container {
                padding: 8px;
                gap: 8px;
            }
            
            .status-card {
                padding: 12px;
            }
            
            .api-status {
                font-size: 1.1em;
                padding: 12px;
            }
            
            .stat-value {
                font-size: 1.2em;
            }
        }

        /* è§¸æ§å„ªåŒ– */
        .metric, .stat-item {
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        /* é˜²æ­¢æ–‡å­—é¸æ“‡ */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <!-- é€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <div class="connection-status" id="connection-status"></div>

    <!-- è­¦å ±è¦†è“‹å±¤ -->
    <div class="alert-overlay" id="alert-overlay">
        <div class="alert-content">
            <h2>ğŸš¨ ç³»çµ±è­¦å ±</h2>
            <p id="alert-message">é€£ç·šéŒ¯èª¤</p>
            <div>
                <button class="alert-button" onclick="dismissAlert()">ç¢ºèª</button>
                <button class="alert-button" onclick="retryConnection()">é‡è©¦</button>
            </div>
        </div>
    </div>

    <div class="header">
        <h1>ğŸš€ API ç›£æ§ä¸­å¿ƒ</h1>
        <div class="time-display" id="current-time">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="main-container">
        <!-- APIç‹€æ…‹ -->
        <div class="status-card">
            <h3>
                <span class="status-indicator" id="api-status-indicator"></span>
                ğŸŒ API ç‹€æ…‹
            </h3>
            <div class="api-status" id="api-status-display">
                {{ state.status }}
            </div>
            <div class="metric">
                <span class="metric-label">æœ€å¾Œæª¢æŸ¥æ™‚é–“</span>
                <span class="metric-value" id="last-check-time">{{ state.last_check_time.split(' ')[1] if ' ' in state.last_check_time else state.last_check_time }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">ä¸‹æ¬¡æª¢æŸ¥æ™‚é–“</span>
                <span class="metric-value" id="next-check-time">{{ state.next_check_time.split(' ')[1] if ' ' in state.next_check_time else state.next_check_time }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">æª¢æŸ¥é–“éš”</span>
                <span class="metric-value">{{ state.check_interval // 60 }} åˆ†é˜</span>
            </div>
        </div>

        <!-- çµ±è¨ˆè³‡æ–™ -->
        <div class="status-card">
            <h3>
                <span class="status-indicator status-success"></span>
                ğŸ“Š çµ±è¨ˆè³‡æ–™
            </h3>
            <div class="stats-grid">
                <div class="stat-item info-stat">
                    <div class="stat-value" id="total-checks">{{ state.total_checks }}</div>
                    <div class="stat-label">ç¸½æª¢æŸ¥æ¬¡æ•¸</div>
                </div>
                <div class="stat-item success-stat">
                    <div class="stat-value" id="successful-checks">{{ state.successful_checks }}</div>
                    <div class="stat-label">æˆåŠŸæ¬¡æ•¸</div>
                </div>
                <div class="stat-item error-stat">
                    <div class="stat-value" id="failed-checks">{{ state.failed_checks }}</div>
                    <div class="stat-label">å¤±æ•—æ¬¡æ•¸</div>
                </div>
                <div class="stat-item info-stat">
                    <div class="stat-value" id="success-rate">
                        {% if state.total_checks > 0 %}
                            {{ "%.1f"|format(state.successful_checks / state.total_checks * 100) }}%
                        {% else %}
                            0%
                        {% endif %}
                    </div>
                    <div class="stat-label">æˆåŠŸç‡</div>
                </div>
            </div>
        </div>

        <!-- ç³»çµ±è³‡è¨Š -->
        <div class="status-card">
            <h3>
                <span class="status-indicator status-warning"></span>
                âš™ï¸ ç³»çµ±è³‡è¨Š
            </h3>
            <div class="metric">
                <span class="metric-label">ç¨‹å¼é‹è¡Œæ™‚é–“</span>
                <span class="metric-value" id="uptime">{{ state.uptime }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">ç³»çµ±ç‰ˆæœ¬</span>
                <span class="metric-value">{{ state.system_version }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">æœ€å¾ŒæˆåŠŸæ™‚é–“</span>
                <span class="metric-value" id="last-success-time">
                    {% if state.last_success_time %}
                        {{ state.last_success_time.split(' ')[1] if ' ' in state.last_success_time else state.last_success_time }}
                    {% else %}
                        å°šæœªæˆåŠŸ
                    {% endif %}
                </span>
            </div>
            <div class="metric">
                <span class="metric-label">æœ€å¾Œå¤±æ•—æ™‚é–“</span>
                <span class="metric-value" id="last-failure-time">
                    {% if state.last_failure_time %}
                        {{ state.last_failure_time.split(' ')[1] if ' ' in state.last_failure_time else state.last_failure_time }}
                    {% else %}
                        ç„¡å¤±æ•—è¨˜éŒ„
                    {% endif %}
                </span>
            </div>
        </div>
    </div>

    <script>
        let alertInterval;
        let dataFetchInterval;
        let isAlertActive = false;
        let consecutiveFailures = 0;
        let audioContext;
        let oscillator;

        // åˆå§‹åŒ–éŸ³é »ä¸Šä¸‹æ–‡
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('éŸ³é »ä¸Šä¸‹æ–‡åˆå§‹åŒ–å¤±æ•—:', e);
            }
        }

        // æ’­æ”¾è­¦å ±éŸ³
        function playAlarm() {
            if (!audioContext) return;
            
            try {
                oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('è­¦å ±éŸ³æ’­æ”¾å¤±æ•—:', e);
            }
        }

        // æ›´æ–°å³æ™‚æ™‚é–“
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('current-time').textContent = timeString;
        }

        // æ›´æ–°APIç‹€æ…‹é¡¯ç¤º
        function updateApiStatus(status) {
            const statusDisplay = document.getElementById('api-status-display');
            const statusIndicator = document.getElementById('api-status-indicator');
            
            statusDisplay.textContent = status;
            statusDisplay.className = 'api-status';
            statusIndicator.className = 'status-indicator';
            
            if (status === 'âœ… æˆåŠŸ') {
                statusDisplay.classList.add('api-success');
                statusIndicator.classList.add('status-success');
                consecutiveFailures = 0;
                stopAlert();
            } else if (status === 'ğŸš¨ ç•°å¸¸') {
                statusDisplay.classList.add('api-error');
                statusIndicator.classList.add('status-error');
                consecutiveFailures++;
                if (consecutiveFailures >= 2) {
                    startAlert('API é€£ç·šç•°å¸¸');
                }
            } else {
                statusDisplay.classList.add('api-waiting');
                statusIndicator.classList.add('status-warning');
            }
        }

        // é–‹å§‹è­¦å ±
        function startAlert(message) {
            if (isAlertActive) return;
            
            isAlertActive = true;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-overlay').style.display = 'flex';
            
            // æ¯10ç§’éŸ¿ä¸€æ¬¡è­¦å ±
            alertInterval = setInterval(() => {
                playAlarm();
            }, 10000);
            
            // ç«‹å³æ’­æ”¾ä¸€æ¬¡è­¦å ±
            playAlarm();
        }

        // åœæ­¢è­¦å ±
        function stopAlert() {
            if (!isAlertActive) return;
            
            isAlertActive = false;
            document.getElementById('alert-overlay').style.display = 'none';
            
            if (alertInterval) {
                clearInterval(alertInterval);
                alertInterval = null;
            }
        }

        // é—œé–‰è­¦å ±
        function dismissAlert() {
            stopAlert();
        }

        // é‡è©¦é€£ç·š
        function retryConnection() {
            stopAlert();
            consecutiveFailures = 0;
            fetchStatus();
        }

        // æ›´æ–°é€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨
        function updateConnectionStatus(isConnected) {
            const statusIndicator = document.getElementById('connection-status');
            if (isConnected) {
                statusIndicator.classList.remove('disconnected');
            } else {
                statusIndicator.classList.add('disconnected');
            }
        }

        // æ›´æ–°é é¢è³‡æ–™
        function updatePageData(data) {
            // æ›´æ–°APIç‹€æ…‹
            updateApiStatus(data.status);
            
            // æ›´æ–°æ™‚é–“
            const lastCheckTime = data.last_check_time.split(' ')[1] || data.last_check_time;
            const nextCheckTime = data.next_check_time.split(' ')[1] || data.next_check_time;
            document.getElementById('last-check-time').textContent = lastCheckTime;
            document.getElementById('next-check-time').textContent = nextCheckTime;
            
            // æ›´æ–°çµ±è¨ˆè³‡æ–™
            document.getElementById('total-checks').textContent = data.total_checks;
            document.getElementById('successful-checks').textContent = data.successful_checks;
            document.getElementById('failed-checks').textContent = data.failed_checks;
            
            // æ›´æ–°æˆåŠŸç‡
            const successRate = data.total_checks > 0 ? (data.successful_checks / data.total_checks * 100).toFixed(1) : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
            
            // æ›´æ–°ç³»çµ±è³‡è¨Š
            document.getElementById('uptime').textContent = data.uptime;
            
            // æ›´æ–°æœ€å¾ŒæˆåŠŸ/å¤±æ•—æ™‚é–“
            const lastSuccessTime = data.last_success_time ? (data.last_success_time.split(' ')[1] || data.last_success_time) : 'å°šæœªæˆåŠŸ';
            const lastFailureTime = data.last_failure_time ? (data.last_failure_time.split(' ')[1] || data.last_failure_time) : 'ç„¡å¤±æ•—è¨˜éŒ„';
            document.getElementById('last-success-time').textContent = lastSuccessTime;
            document.getElementById('last-failure-time').textContent = lastFailureTime;
            
            // æ›´æ–°é€£ç·šç‹€æ…‹
            updateConnectionStatus(true);
        }

        // ç²å–ç‹€æ…‹è³‡æ–™
        function fetchStatus() {
            fetch('/api/status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    updatePageData(data);
                    updateConnectionStatus(true);
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    updateApiStatus('ğŸš¨ é€£ç·šéŒ¯èª¤');
                    updateConnectionStatus(false);
                    
                    // å¦‚æœé€£çºŒå¤±æ•—ï¼Œé¡¯ç¤ºä¼ºæœå™¨é—œé–‰è­¦å ±
                    consecutiveFailures++;
                    if (consecutiveFailures >= 2) {
                        startAlert('é€£ç·šéŒ¯èª¤ ä¼ºæœå™¨é—œé–‰');
                    }
                });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–éŸ³é »
            initAudio();
            
            // è«‹æ±‚å…¨è¢å¹•æ¬Šé™
            document.addEventListener('click', function() {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }
            }, { once: true });
            
            updateTime();
            
            // æ¯ç§’æ›´æ–°æ™‚é–“
            setInterval(updateTime, 1000);
            
            // æ¯30ç§’æ›´æ–°ç‹€æ…‹ï¼ˆè­¦å ±ç‹€æ…‹ä¸‹ï¼‰
            dataFetchInterval = setInterval(fetchStatus, 30000);
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            fetchStatus();
        });

        // é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚é‡æ–°é–‹å§‹éŸ³é »ä¸Šä¸‹æ–‡
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });
    </script>
</body>
</html>
