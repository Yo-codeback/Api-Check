<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>API Áõ£Êéß‰∏≠ÂøÉ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            overflow-x: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
        }

        /* ÂÖ®Ëû¢ÂπïÊ®°Âºè */
        body.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 16px;
            border-bottom: 2px solid #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 100;
        }

        .header h1 {
            color: #00d4ff;
            font-size: 1.4em;
            text-shadow: 0 0 20px #00d4ff;
            font-weight: 300;
        }

        .time-display {
            font-size: 1.1em;
            color: #00d4ff;
            text-shadow: 0 0 10px #00d4ff;
            font-family: 'Courier New', monospace;
        }

        .main-container {
            height: calc(100vh - 60px);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.2);
        }

        .status-card h3 {
            color: #00d4ff;
            margin-bottom: 12px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-success {
            background: #00ff88;
            box-shadow: 0 0 15px #00ff88;
        }

        .status-error {
            background: #ff4444;
            box-shadow: 0 0 15px #ff4444;
        }

        .status-warning {
            background: #ffaa00;
            box-shadow: 0 0 15px #ffaa00;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .metric-label {
            color: #cccccc;
            font-size: 0.9em;
        }

        .metric-value {
            color: #ffffff;
            font-size: 0.95em;
            font-weight: 500;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .api-status {
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .api-success {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            border: 2px solid #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .api-error {
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
            border: 2px solid #ff4444;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
            animation: errorPulse 1s infinite;
        }

        .api-waiting {
            background: rgba(255, 170, 0, 0.1);
            color: #ffaa00;
            border: 2px solid #ffaa00;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.3);
        }

        @keyframes errorPulse {
            0% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.3); }
            50% { box-shadow: 0 0 30px rgba(255, 68, 68, 0.6); }
            100% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.3); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.8em;
            color: #cccccc;
        }

        .success-stat {
            border-color: rgba(0, 255, 136, 0.3);
        }

        .success-stat .stat-value {
            color: #00ff88;
        }

        .error-stat {
            border-color: rgba(255, 68, 68, 0.3);
        }

        .error-stat .stat-value {
            color: #ff4444;
        }

        .info-stat {
            border-color: rgba(0, 212, 255, 0.3);
        }

        .info-stat .stat-value {
            color: #00d4ff;
        }

        /* Ë≠¶Â†±Ë¶ÜËìãÂ±§ */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: alertBlink 0.5s infinite;
        }

        @keyframes alertBlink {
            0% { background: rgba(255, 0, 0, 0.9); }
            50% { background: rgba(255, 0, 0, 0.7); }
            100% { background: rgba(255, 0, 0, 0.9); }
        }

        .alert-content {
            text-align: center;
            color: white;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .alert-content h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .alert-content p {
            font-size: 0.8em;
            margin-bottom: 20px;
        }

        .alert-button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin: 0 8px;
        }

        .alert-button:hover {
            background: #cc3333;
        }

        /* ÈÄ£Á∑öÁãÄÊÖãÊåáÁ§∫Âô® */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
            z-index: 200;
        }

        .connection-status.disconnected {
            background: #ff4444;
            box-shadow: 0 0 10px #ff4444;
            animation: connectionPulse 1s infinite;
        }

        @keyframes connectionPulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.2em;
            }
            
            .time-display {
                font-size: 1em;
            }
            
            .main-container {
                padding: 8px;
                gap: 8px;
            }
            
            .status-card {
                padding: 12px;
            }
            
            .api-status {
                font-size: 1.1em;
                padding: 12px;
            }
            
            .stat-value {
                font-size: 1.2em;
            }
        }

        /* Ëß∏ÊéßÂÑ™Âåñ */
        .metric, .stat-item {
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        /* Èò≤Ê≠¢ÊñáÂ≠óÈÅ∏Êìá */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <!-- ÈÄ£Á∑öÁãÄÊÖãÊåáÁ§∫Âô® -->
    <div class="connection-status" id="connection-status"></div>

    <!-- Ë≠¶Â†±Ë¶ÜËìãÂ±§ -->
    <div class="alert-overlay" id="alert-overlay">
        <div class="alert-content">
            <h2>üö® Á≥ªÁµ±Ë≠¶Â†±</h2>
            <p id="alert-message">ÈÄ£Á∑öÈåØË™§</p>
            <div>
                <button class="alert-button" onclick="dismissAlert()">Á¢∫Ë™ç</button>
                <button class="alert-button" onclick="retryConnection()">ÈáçË©¶</button>
            </div>
        </div>
    </div>

    <div class="header">
        <h1>üöÄ API Áõ£Êéß‰∏≠ÂøÉ</h1>
        <div class="time-display" id="current-time">ËºâÂÖ•‰∏≠...</div>
    </div>

    <div class="main-container">
        <!-- APIÁãÄÊÖã -->
        <div class="status-card">
            <h3>
                <span class="status-indicator" id="api-status-indicator"></span>
                üåê API ÁãÄÊÖã
            </h3>
            <div class="api-status" id="api-status-display">
                {{ state.status }}
            </div>
            <div class="metric">
                <span class="metric-label">ÊúÄÂæåÊ™¢Êü•ÊôÇÈñì</span>
                <span class="metric-value" id="last-check-time">{{ state.last_check_time.split(' ')[1] if ' ' in state.last_check_time else state.last_check_time }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">‰∏ãÊ¨°Ê™¢Êü•ÊôÇÈñì</span>
                <span class="metric-value" id="next-check-time">{{ state.next_check_time.split(' ')[1] if ' ' in state.next_check_time else state.next_check_time }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">Ê™¢Êü•ÈñìÈöî</span>
                <span class="metric-value">{{ state.check_interval // 60 }} ÂàÜÈêò</span>
            </div>
        </div>

        <!-- Áµ±Ë®àË≥áÊñô -->
        <div class="status-card">
            <h3>
                <span class="status-indicator status-success"></span>
                üìä Áµ±Ë®àË≥áÊñô
            </h3>
            <div class="stats-grid">
                <div class="stat-item info-stat">
                    <div class="stat-value" id="total-checks">{{ state.total_checks }}</div>
                    <div class="stat-label">Á∏ΩÊ™¢Êü•Ê¨°Êï∏</div>
                </div>
                <div class="stat-item success-stat">
                    <div class="stat-value" id="successful-checks">{{ state.successful_checks }}</div>
                    <div class="stat-label">ÊàêÂäüÊ¨°Êï∏</div>
                </div>
                <div class="stat-item error-stat">
                    <div class="stat-value" id="failed-checks">{{ state.failed_checks }}</div>
                    <div class="stat-label">Â§±ÊïóÊ¨°Êï∏</div>
                </div>
                <div class="stat-item info-stat">
                    <div class="stat-value" id="success-rate">
                        {% if state.total_checks > 0 %}
                            {{ "%.1f"|format(state.successful_checks / state.total_checks * 100) }}%
                        {% else %}
                            0%
                        {% endif %}
                    </div>
                    <div class="stat-label">ÊàêÂäüÁéá</div>
                </div>
            </div>
        </div>

        <!-- Á≥ªÁµ±Ë≥áË®ä -->
        <div class="status-card">
            <h3>
                <span class="status-indicator status-warning"></span>
                ‚öôÔ∏è Á≥ªÁµ±Ë≥áË®ä
            </h3>
            <div class="metric">
                <span class="metric-label">Á®ãÂºèÈÅãË°åÊôÇÈñì</span>
                <span class="metric-value" id="uptime">{{ state.uptime }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">Á≥ªÁµ±ÁâàÊú¨</span>
                <span class="metric-value">{{ state.system_version }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">ÊúÄÂæåÊàêÂäüÊôÇÈñì</span>
                <span class="metric-value" id="last-success-time">
                    {% if state.last_success_time %}
                        {{ state.last_success_time.split(' ')[1] if ' ' in state.last_success_time else state.last_success_time }}
                    {% else %}
                        Â∞öÊú™ÊàêÂäü
                    {% endif %}
                </span>
            </div>
            <div class="metric">
                <span class="metric-label">ÊúÄÂæåÂ§±ÊïóÊôÇÈñì</span>
                <span class="metric-value" id="last-failure-time">
                    {% if state.last_failure_time %}
                        {{ state.last_failure_time.split(' ')[1] if ' ' in state.last_failure_time else state.last_failure_time }}
                    {% else %}
                        ÁÑ°Â§±ÊïóË®òÈåÑ
                    {% endif %}
                </span>
            </div>
        </div>
    </div>

    <script>
        let alertInterval;
        let dataFetchInterval;
        let isAlertActive = false;
        let consecutiveFailures = 0;
        let audioContext;
        let oscillator;

        // ÂàùÂßãÂåñÈü≥È†ª‰∏ä‰∏ãÊñá
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Èü≥È†ª‰∏ä‰∏ãÊñáÂàùÂßãÂåñÂ§±Êïó:', e);
            }
        }

        // Êí≠ÊîæË≠¶Â†±Èü≥
        function playAlarm() {
            if (!audioContext) return;
            
            try {
                oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Ë≠¶Â†±Èü≥Êí≠ÊîæÂ§±Êïó:', e);
            }
        }

        // Êõ¥Êñ∞Âç≥ÊôÇÊôÇÈñì
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('current-time').textContent = timeString;
        }

        // Êõ¥Êñ∞APIÁãÄÊÖãÈ°ØÁ§∫
        function updateApiStatus(status) {
            const statusDisplay = document.getElementById('api-status-display');
            const statusIndicator = document.getElementById('api-status-indicator');
            
            statusDisplay.textContent = status;
            statusDisplay.className = 'api-status';
            statusIndicator.className = 'status-indicator';
            
            if (status === '‚úÖ ÊàêÂäü') {
                statusDisplay.classList.add('api-success');
                statusIndicator.classList.add('status-success');
                consecutiveFailures = 0;
                stopAlert();
            } else if (status === 'üö® Áï∞Â∏∏') {
                statusDisplay.classList.add('api-error');
                statusIndicator.classList.add('status-error');
                consecutiveFailures++;
                if (consecutiveFailures >= 2) {
                    startAlert('API ÈÄ£Á∑öÁï∞Â∏∏');
                }
            } else {
                statusDisplay.classList.add('api-waiting');
                statusIndicator.classList.add('status-warning');
            }
        }

        // ÈñãÂßãË≠¶Â†±
        function startAlert(message) {
            if (isAlertActive) return;
            
            isAlertActive = true;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-overlay').style.display = 'flex';
            
            // ÊØè10ÁßíÈüø‰∏ÄÊ¨°Ë≠¶Â†±
            alertInterval = setInterval(() => {
                playAlarm();
            }, 10000);
            
            // Á´ãÂç≥Êí≠Êîæ‰∏ÄÊ¨°Ë≠¶Â†±
            playAlarm();
        }

        // ÂÅúÊ≠¢Ë≠¶Â†±
        function stopAlert() {
            if (!isAlertActive) return;
            
            isAlertActive = false;
            document.getElementById('alert-overlay').style.display = 'none';
            
            if (alertInterval) {
                clearInterval(alertInterval);
                alertInterval = null;
            }
        }

        // ÈóúÈñâË≠¶Â†±
        function dismissAlert() {
            stopAlert();
        }

        // ÈáçË©¶ÈÄ£Á∑ö
        function retryConnection() {
            stopAlert();
            consecutiveFailures = 0;
            fetchStatus();
        }

        // Êõ¥Êñ∞ÈÄ£Á∑öÁãÄÊÖãÊåáÁ§∫Âô®
        function updateConnectionStatus(isConnected) {
            const statusIndicator = document.getElementById('connection-status');
            if (isConnected) {
                statusIndicator.classList.remove('disconnected');
            } else {
                statusIndicator.classList.add('disconnected');
            }
        }

        // Êõ¥Êñ∞È†ÅÈù¢Ë≥áÊñô
        function updatePageData(data) {
            // Êõ¥Êñ∞APIÁãÄÊÖã
            updateApiStatus(data.status);
            
            // Êõ¥Êñ∞ÊôÇÈñì
            const lastCheckTime = data.last_check_time.split(' ')[1] || data.last_check_time;
            const nextCheckTime = data.next_check_time.split(' ')[1] || data.next_check_time;
            document.getElementById('last-check-time').textContent = lastCheckTime;
            document.getElementById('next-check-time').textContent = nextCheckTime;
            
            // Êõ¥Êñ∞Áµ±Ë®àË≥áÊñô
            document.getElementById('total-checks').textContent = data.total_checks;
            document.getElementById('successful-checks').textContent = data.successful_checks;
            document.getElementById('failed-checks').textContent = data.failed_checks;
            
            // Êõ¥Êñ∞ÊàêÂäüÁéá
            const successRate = data.total_checks > 0 ? (data.successful_checks / data.total_checks * 100).toFixed(1) : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
            
            // Êõ¥Êñ∞Á≥ªÁµ±Ë≥áË®ä
            document.getElementById('uptime').textContent = data.uptime;
            
            // Êõ¥Êñ∞ÊúÄÂæåÊàêÂäü/Â§±ÊïóÊôÇÈñì
            const lastSuccessTime = data.last_success_time ? (data.last_success_time.split(' ')[1] || data.last_success_time) : 'Â∞öÊú™ÊàêÂäü';
            const lastFailureTime = data.last_failure_time ? (data.last_failure_time.split(' ')[1] || data.last_failure_time) : 'ÁÑ°Â§±ÊïóË®òÈåÑ';
            document.getElementById('last-success-time').textContent = lastSuccessTime;
            document.getElementById('last-failure-time').textContent = lastFailureTime;
            
            // Êõ¥Êñ∞ÈÄ£Á∑öÁãÄÊÖã
            updateConnectionStatus(true);
        }

        // Áç≤ÂèñÁãÄÊÖãË≥áÊñô
        function fetchStatus() {
            fetch('/api/status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    updatePageData(data);
                    updateConnectionStatus(true);
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    updateApiStatus('üö® ÈÄ£Á∑öÈåØË™§');
                    updateConnectionStatus(false);
                    
                    // Â¶ÇÊûúÈÄ£Á∫åÂ§±ÊïóÔºåÈ°ØÁ§∫‰º∫ÊúçÂô®ÈóúÈñâË≠¶Â†±
                    consecutiveFailures++;
                    if (consecutiveFailures >= 2) {
                        startAlert('ÈÄ£Á∑öÈåØË™§ ‰º∫ÊúçÂô®ÈóúÈñâ');
                    }
                });
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñÈü≥È†ª
            initAudio();
            
            // Ë´ãÊ±ÇÂÖ®Ëû¢ÂπïÊ¨äÈôê
            document.addEventListener('click', function() {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }
            }, { once: true });
            
            updateTime();
            
            // ÊØèÁßíÊõ¥Êñ∞ÊôÇÈñì
            setInterval(updateTime, 1000);
            
            // ÊØè30ÁßíÊõ¥Êñ∞ÁãÄÊÖãÔºàË≠¶Â†±ÁãÄÊÖã‰∏ãÔºâ
            dataFetchInterval = setInterval(fetchStatus, 30000);
            
            // Á´ãÂç≥Âü∑Ë°å‰∏ÄÊ¨°
            fetchStatus();
        });

        // È†ÅÈù¢ÂèØË¶ãÊÄßËÆäÂåñÊôÇÈáçÊñ∞ÈñãÂßãÈü≥È†ª‰∏ä‰∏ãÊñá
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });
    </script>
</body>
</html>
